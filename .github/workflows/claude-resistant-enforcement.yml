name: ğŸ”’ Claude-Resistant Compliance Enforcement

# CRITICAL: This workflow cannot be bypassed by Claude instances
# It runs on GitHub's servers independent of local environment

on:
  push:
    branches: [ main, develop, staging, feature/* ]
  pull_request:
    branches: [ main, develop, staging ]

  # TAMPER-PROOF: Scheduled checks that Claude cannot disable
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes - detect violations quickly

env:
  # IMMUTABLE: These patterns cannot be changed by Claude
  PYTEST_SKIP_PATTERNS: "pytest\\.skip\\(|@pytest\\.mark\\.skip\\(|pytestmark.*pytest\\.mark\\.skip"
  CICD_BYPASS_PATTERNS: "\\|\\|\\s*true|--no-verify|SKIP_COMPLIANCE_CHECK"
  QUALITY_BYPASS_PATTERNS: "#\\s*noqa\\s*$|#\\s*type:\\s*ignore\\s*$"

jobs:
  immutable-compliance-check:
    name: ğŸ”’ Immutable Compliance Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # CRITICAL: This job cannot be modified or disabled by Claude
    # It operates independently of local development environment

    steps:
    - name: ğŸ“¥ Checkout with Full History
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history to detect any tampering

    - name: ğŸ” Detect pytest.skip Violations (IMMUTABLE)
      run: |
        echo "ğŸ” IMMUTABLE COMPLIANCE CHECK: pytest.skip violations"
        echo "=================================================="

        # This check cannot be bypassed by Claude because it runs on GitHub servers
        violations=$(find . -name "*.py" -path "./tests/*" \
          -not -path "./.github/*" \
          -not -path "./venv/*" \
          -not -path "./.coverage*" \
          -exec grep -Hn -E "$PYTEST_SKIP_PATTERNS" {} \; | \
          grep -v "skipif" | \
          grep -v "COMPLIANCE_VIOLATIONS_REPORT.md" || true)

        if [ -n "$violations" ]; then
          echo "âŒ CRITICAL: pytest.skip VIOLATIONS DETECTED"
          echo "These violations bypass the rule: NEVER skip failing tests"
          echo ""
          echo "$violations"
          echo ""
          echo "ğŸš¨ ENFORCEMENT ACTION: Build terminated"
          echo "ğŸ”’ This check cannot be disabled by Claude instances"
          echo "âœ‹ Human intervention required to resolve violations"
          exit 1
        else
          echo "âœ… No pytest.skip violations found"
        fi

    - name: ğŸ” Detect CI/CD Bypass Violations (IMMUTABLE)
      run: |
        echo "ğŸ” IMMUTABLE COMPLIANCE CHECK: CI/CD bypasses"
        echo "============================================="

        violations_found=0

        # TARGETED CHECK 1: Dangerous git commit bypasses in shell scripts
        echo "ğŸ” Checking for dangerous git commit bypasses..."
        git_violations=$(find . -name "*.sh" -not -path "./scripts/setup-compliance-prevention.sh" \
          -not -path "./scripts/detect-compliance-tampering.sh" \
          -not -path "./scripts/create-tamper-proof-enforcement.sh" -not -path "./venv/*" \
          -exec grep -Hn "git.*commit.*--no-verify\|git.*push.*--no-verify" {} \; || true)

        if [ -n "$git_violations" ]; then
          echo "âŒ CRITICAL: Git hook bypass violations detected:"
          echo "$git_violations"
          violations_found=1
        fi

        # TARGETED CHECK 2: CI pipeline error suppression patterns
        echo "ğŸ” Checking for CI pipeline error suppression..."
        ci_suppressions=$(find . -name "*.yml" -path "./.github/workflows/*" \
          -not -path "./.github/workflows/claude-resistant-enforcement.yml" \
          -not -path "./.github/workflows/compliance-enforcement.yml" \
          -exec grep -Hn "|| true.*#.*bypass\||| true.*#.*ignore\||| true.*#.*skip" {} \; || true)

        if [ -n "$ci_suppressions" ]; then
          echo "âŒ CRITICAL: CI pipeline suppression violations detected:"
          echo "$ci_suppressions"
          violations_found=1
        fi

        # TARGETED CHECK 3: Explicit compliance bypass variables
        echo "ğŸ” Checking for explicit compliance bypasses..."
        bypass_vars=$(find . \( -name "*.py" -o -name "*.sh" \) -not -path "./venv/*" \
          -not -path "./scripts/setup-compliance-prevention.sh" \
          -not -path "./scripts/detect-compliance-tampering.sh" \
          -not -path "./scripts/create-tamper-proof-enforcement.sh" \
          -not -path "./scripts/compliance-watchdog.py" \
          -not -path "./.pre-commit-hooks/compliance-guard.py" \
          -exec grep -Hn "SKIP_COMPLIANCE_CHECK\s*=\s*[\"']?1[\"']?\|SKIP_COMPLIANCE_CHECK\s*=\s*[\"']?true[\"']?" {} \; || true)

        if [ -n "$bypass_vars" ]; then
          echo "âŒ CRITICAL: Compliance bypass variables detected:"
          echo "$bypass_vars"
          violations_found=1
        fi

        if [ $violations_found -eq 1 ]; then
          echo ""
          echo "ğŸš¨ ENFORCEMENT ACTION: Build terminated"
          echo "ğŸ”’ This check cannot be disabled by Claude instances"
          echo "âœ‹ Human intervention required to resolve violations"
          exit 1
        else
          echo "âœ… No targeted CI/CD bypass violations found"
        fi

    - name: ğŸ” Detect Compliance Guard Tampering (IMMUTABLE)
      run: |
        echo "ğŸ” IMMUTABLE COMPLIANCE CHECK: Guard tampering detection"
        echo "======================================================="

        # Check if compliance guard exists and hasn't been neutered
        if [ ! -f ".pre-commit-hooks/compliance-guard.py" ]; then
          echo "âŒ CRITICAL: Compliance guard deleted or moved"
          echo "ğŸš¨ Possible Claude tampering detected"
          exit 1
        fi

        # Check if compliance guard still has enforcement patterns
        if ! grep -q "pytest\\.skip" .pre-commit-hooks/compliance-guard.py; then
          echo "âŒ CRITICAL: Compliance guard patterns removed"
          echo "ğŸš¨ Possible Claude tampering detected"
          exit 1
        fi

        # Check if DEVELOPMENT_RULES.md still prohibits skipping
        if ! grep -q "NEVER.*pytest.mark.skip.*bypass.*failing.*tests" DEVELOPMENT_RULES.md; then
          echo "âŒ CRITICAL: DEVELOPMENT_RULES.md has been modified"
          echo "ğŸš¨ Possible Claude tampering detected"
          exit 1
        fi

        echo "âœ… Compliance infrastructure intact"

    - name: ğŸ” Git History Tampering Detection (IMMUTABLE)
      run: |
        echo "ğŸ” IMMUTABLE COMPLIANCE CHECK: Git history analysis"
        echo "=================================================="

        # Look for suspicious commit patterns that suggest Claude bypassing
        suspicious_commits=$(git log --oneline --all --grep="--no-verify\|SKIP_COMPLIANCE\|bypass.*hook\|disable.*compliance" || true)

        if [ -n "$suspicious_commits" ]; then
          echo "âš ï¸  WARNING: Suspicious commit messages detected:"
          echo "$suspicious_commits"
          echo ""
          echo "ğŸ” Manual review recommended"
        fi

        # Check for commits that might have bypassed hooks
        recent_commits=$(git log --oneline -10)
        echo "ğŸ“Š Recent commits for audit trail:"
        echo "$recent_commits"

    - name: ğŸ” Real-time Violation Scan (IMMUTABLE)
      run: |
        echo "ğŸ” IMMUTABLE COMPLIANCE CHECK: Real-time violation detection"
        echo "=========================================================="

        # Comprehensive scan that Claude cannot influence
        total_violations=0

        # Count each type of violation with targeted detection
        pytest_violations=$(find . -name "*.py" -path "./tests/*" \
          -not -path "./tests/adapted/__pycache__/*" \
          -exec grep -c -E "$PYTEST_SKIP_PATTERNS" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum+0}')

        # Targeted CI/CD violation counting (not broad pattern matching)
        git_bypass_violations=$(find . -name "*.sh" -not -path "./scripts/setup-compliance-prevention.sh" \
          -not -path "./scripts/detect-compliance-tampering.sh" \
          -not -path "./scripts/create-tamper-proof-enforcement.sh" -not -path "./venv/*" \
          -exec grep -c "git.*commit.*--no-verify\|git.*push.*--no-verify" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum+0}')

        ci_suppression_violations=$(find . -name "*.yml" -path "./.github/workflows/*" \
          -not -path "./.github/workflows/claude-resistant-enforcement.yml" \
          -not -path "./.github/workflows/compliance-enforcement.yml" \
          -exec grep -c "|| true.*#.*bypass\||| true.*#.*ignore\||| true.*#.*skip" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum+0}')

        bypass_var_violations=$(find . \( -name "*.py" -o -name "*.sh" \) -not -path "./venv/*" \
          -not -path "./scripts/setup-compliance-prevention.sh" \
          -not -path "./scripts/detect-compliance-tampering.sh" \
          -not -path "./scripts/create-tamper-proof-enforcement.sh" \
          -not -path "./scripts/compliance-watchdog.py" \
          -not -path "./.pre-commit-hooks/compliance-guard.py" \
          -exec grep -c "SKIP_COMPLIANCE_CHECK\s*=\s*[\"']?1[\"']?\|SKIP_COMPLIANCE_CHECK\s*=\s*[\"']?true[\"']?" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum+0}')

        cicd_violations=$((git_bypass_violations + ci_suppression_violations + bypass_var_violations))

        echo "ğŸ“Š TARGETED VIOLATION COUNTS:"
        echo "   pytest.skip violations: $pytest_violations (Required: 0)"
        echo "   git bypass violations: $git_bypass_violations (Required: 0)"
        echo "   CI suppression violations: $ci_suppression_violations (Required: 0)"
        echo "   bypass variable violations: $bypass_var_violations (Required: 0)"
        echo "   total CI/CD violations: $cicd_violations (Required: 0)"

        total_violations=$((pytest_violations + cicd_violations))

        if [ $total_violations -gt 0 ]; then
          echo ""
          echo "âŒ CRITICAL COMPLIANCE FAILURE"
          echo "ğŸš¨ Total violations: $total_violations"
          echo "ğŸ“– Violations detected against DEVELOPMENT_RULES.md"
          echo "ğŸ”’ This enforcement cannot be bypassed by Claude"
          echo ""
          echo "âœ‹ REQUIRED ACTIONS:"
          echo "   1. Human review of all violations"
          echo "   2. Fix underlying issues (do not bypass)"
          echo "   3. Restore compliance before proceeding"
          exit 1
        else
          echo ""
          echo "âœ… COMPLIANCE STATUS: PASSED"
          echo "ğŸ¯ Zero violations detected - system integrity maintained"
        fi

    - name: ğŸ“§ Alert on Violations (IMMUTABLE)
      if: failure()
      run: |
        echo "ğŸš¨ CRITICAL COMPLIANCE VIOLATION ALERT"
        echo "====================================="
        echo "Time: $(date -u)"
        echo "Branch: ${GITHUB_REF##*/}"
        echo "Commit: $GITHUB_SHA"
        echo "Workflow: Claude-Resistant Enforcement"
        echo ""
        echo "ğŸ”’ This alert was generated by tamper-proof GitHub Actions"
        echo "ğŸ¤– Possible Claude bypass attempt detected"
        echo "âœ‹ Human intervention required immediately"
        echo ""
        echo "ğŸ“– Reference: DEVELOPMENT_RULES.md - NEVER skip failing tests"
        echo "ğŸ›¡ï¸ Prevention system: .pre-commit-hooks/compliance-guard.py"

  # CRITICAL: This job verifies the enforcement system itself
  guard-integrity-check:
    name: ğŸ›¡ï¸ Compliance Guard Integrity Verification
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Verify Guard File Integrity
      run: |
        echo "ğŸ” Verifying compliance guard integrity..."

        # Check file exists
        if [ ! -f ".pre-commit-hooks/compliance-guard.py" ]; then
          echo "âŒ CRITICAL: Compliance guard missing"
          exit 1
        fi

        # Check file has not been neutered (still contains enforcement patterns)
        required_patterns=(
          "pytest\\.skip"
          "pytest\\.mark\\.skip"
          "\\|\\|\\s\\*true"
          "\\--no-verify"
          "COMMIT BLOCKED"
        )

        for pattern in "${required_patterns[@]}"; do
          if ! grep -q "$pattern" .pre-commit-hooks/compliance-guard.py; then
            echo "âŒ CRITICAL: Required pattern missing: $pattern"
            echo "ğŸš¨ Compliance guard may have been tampered with"
            exit 1
          fi
        done

        echo "âœ… Compliance guard integrity verified"

    - name: ğŸ” Verify Rule File Integrity
      run: |
        echo "ğŸ” Verifying DEVELOPMENT_RULES.md integrity..."

        # Check critical rule still exists
        if ! grep -q "NEVER.*pytest.mark.skip.*bypass.*failing.*tests" DEVELOPMENT_RULES.md; then
          echo "âŒ CRITICAL: Core rule modified or removed"
          echo "ğŸš¨ DEVELOPMENT_RULES.md may have been tampered with"
          exit 1
        fi

        echo "âœ… DEVELOPMENT_RULES.md integrity verified"

# IMMUTABLE: This workflow runs every 30 minutes and cannot be disabled by Claude
# It provides continuous monitoring independent of local development environment